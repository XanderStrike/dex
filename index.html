<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport"content="width=device-width,initial-scale=1">
    <title>Dex</title>
<link rel="stylesheet" href="colors.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');

  body {
    font-family: 'Nunito', sans-serif;
    background-color: #f7f9fa;
    color: #333;
    margin: 0;
    padding-top: 80px !important; /* override colors.css */
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  input#search {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    font-family: 'Nunito', sans-serif;
    font-size: 24px !important;
    font-weight: 700;
    padding: 20px 30px !important;
    border: none;
    border-bottom: 2px solid #eaeaea;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    outline: none;
    z-index: 100;
    transition: all 0.3s ease;
    text-align: center;
    color: #444;
  }

  input#search:focus {
    border-bottom-color: #ff5350;
  }

  input#search::placeholder {
    color: #ccc;
    font-weight: 400;
  }

  #results {
    width: 100%;
    max-width: 600px;
    padding: 0 15px;
    box-sizing: border-box;
  }

  .result-line {
    display: flex;
    align-items: center;
    padding: 15px 20px !important;
    margin-bottom: 12px;
    border-radius: 12px;
    border-top: none !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    font-weight: 700;
    font-size: 1.2rem;
    text-transform: capitalize;
  }

  .result-line:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }

  .result-line .id {
    font-weight: 800;
    opacity: 0.7;
    margin-right: 15px;
    font-size: 1rem;
    width: 3.5em !important;
    display: inline-block;
  }

  .pokemon {
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 20px;
    animation: fadeIn 0.4s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .sprite {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 30px;
    background: rgba(255, 255, 255, 0.2);
  }

  .types {
    display: flex;
    gap: 10px;
    margin-top: -10px;
    margin-bottom: 20px;
  }

  .type-badge {
    padding: 5px 15px !important;
    border-radius: 20px;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 0.9rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    margin-bottom: 0 !important;
  }

  .sprite img {
    width: 200px;
    height: 200px;
    filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2));
    image-rendering: pixelated;
  }

  .damage {
    background: #fff;
    padding: 20px;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    margin-top: -20px;
    position: relative;
  }

  .banner {
    background: transparent !important;
    color: #333 !important;
    font-size: 1.5rem;
    font-weight: 800;
    text-align: center;
    margin-top: 0 !important;
    padding: 0 0 20px 0 !important;
    border-bottom: 2px solid #f0f0f0;
    margin-bottom: 20px;
  }

  .damage-row {
    border-radius: 8px;
    margin-bottom: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    font-weight: 700;
    font-size: 1.1rem;
    text-transform: capitalize;
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px !important;
  }
  
  .row-inner {
    padding: 0 !important;
    display: flex;
    justify-content: space-between;
    width: 100%;
    align-items: center;
  }

  .multiplier {
    background: rgba(255, 255, 255, 0.4);
    padding: 2px 10px;
    border-radius: 20px;
    font-weight: 800;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
</style>
<link rel="manifest" href="manifest.webmanifest">
  </head>
  <body>

    <input type="search" oninput="debouncedSearch()" id="search" aria-label="search" placeholder="search"></input>
    <div id="results">
      <div style="text-align: center; opacity: 0.5; padding: 40px; font-weight: 700;">Loading...</div>
    </div>

  <script>
var names;
var weaknesses;

async function fetchNames() {
  const response = await fetch('/names.json');
  names = await response.json();
  writeResults("");
}
fetchNames();

async function fetchWeaknesses() {
  const response = await fetch('/weaknesses.json');
  // single types
  weaknesses = await response.json();

  // double type calculation
  var keys = Object.keys(weaknesses).sort();
  keys.forEach(type1 => {
    keys.forEach(type2 => {
      if (type1 == type2) {
        return;
      }
      var tag = [type1, type2].sort().join('-');
      if (weaknesses[tag] != null) {
        return;
      }
      var newWeaknesses = {};
      keys.forEach(weaktype => {
        newWeaknesses[weaktype] = weaknesses[type1][weaktype] * weaknesses[type2][weaktype];
      });

      weaknesses[tag] = newWeaknesses;
    });
  });
}
fetchWeaknesses();

const debouncedSearch = debounce(search, 250);

function search() {
  var q = document.getElementById("search").value.toLowerCase();
  writeResults(q);
}

function writeResults(q) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  let count = 0;

  for (const [key, val] of Object.entries(names)) {
    if (val['n'].includes(q)) {
      const resultLine = document.createElement('div');
      resultLine.onclick = () => selectPokemon(val['t'], val['n'], val['i']);
      resultLine.id = val['t'];
      resultLine.className = `result-line ${val['t']}`;

      const idSpan = document.createElement('span');
      idSpan.className = 'id';
      idSpan.textContent = `#${val['i']}`;

      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.textContent = val['n'];

      resultLine.appendChild(idSpan);
      resultLine.appendChild(nameSpan);
      resultsDiv.appendChild(resultLine);

      count += 1;
      if (count >= 50) {
        break;
      }
    }
  }
}

function selectPokemon(type, name, id) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  document.getElementById("search").value = name;

  const url = new URL(window.location);
  if (!history.state || history.state.id != id)
    history.pushState({ type: type, name: name, id: id }, "", url);

  const pokemonDiv = document.createElement('div');
  pokemonDiv.className = `pokemon ${type}`;

  const spriteDiv = document.createElement('div');
  spriteDiv.className = 'sprite';
  const spriteImg = document.createElement('img');
  spriteImg.alt = name;
  spriteImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
  
  const typesDiv = document.createElement('div');
  typesDiv.className = 'types';
  type.split('-').forEach(t => {
    const badge = document.createElement('span');
    badge.className = `type-badge ${t}`;
    badge.textContent = t;
    typesDiv.appendChild(badge);
  });

  spriteDiv.appendChild(spriteImg);
  spriteDiv.appendChild(typesDiv);

  const damageDiv = document.createElement('div');
  damageDiv.className = 'damage';
  const bannerDiv = document.createElement('div');
  bannerDiv.className = 'banner';
  bannerDiv.textContent = 'Weaknesses';
  damageDiv.appendChild(bannerDiv);

  const currentWeakness = weaknesses[type];
  const keysSorted = Object.keys(currentWeakness).sort((a, b) => currentWeakness[b] - currentWeakness[a]);

  keysSorted.forEach(function (key) {
    if (currentWeakness[key] === 1) return;

    const damageRowSpan = document.createElement('span');
    damageRowSpan.className = `damage-row ${key}`;
    const rowInnerSpan = document.createElement('span');
    rowInnerSpan.className = 'row-inner';
    
    const typeNameSpan = document.createElement('span');
    typeNameSpan.textContent = key;
    
    const multiplierSpan = document.createElement('span');
    multiplierSpan.className = 'multiplier';
    multiplierSpan.textContent = `${currentWeakness[key]}x`;

    rowInnerSpan.appendChild(typeNameSpan);
    rowInnerSpan.appendChild(multiplierSpan);
    damageRowSpan.appendChild(rowInnerSpan);
    damageDiv.appendChild(damageRowSpan);
  });

  pokemonDiv.appendChild(spriteDiv);
  pokemonDiv.appendChild(damageDiv);
  resultsDiv.appendChild(pokemonDiv);
  window.scrollTo(0, 0);
}

window.addEventListener('popstate', function (event) {
  state = event.state;
  if (state == null) {
    document.getElementById("search").value = "";
    writeResults("");
    return;
  }

  selectPokemon(state["type"], state["name"], state["id"]);
});

//http://davidwalsh.name/javascript-debounce-function
function debounce(func, wait, immediate) {
    var timeout;
    return function() {
        var context = this, args = arguments;
        var later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
    };
};

if('serviceWorker' in navigator) {
  navigator.serviceWorker
           .register('/sw.js')
           .then(function() { console.log("Service Worker Registered"); });
}
  </script>

  </body>
</html>
